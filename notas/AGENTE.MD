# BACKEND - PROJETO ECO

## DocumentaÃ§Ã£o para Agentes de IA

### ESTADO ATUAL DO BACKEND

O backend do projeto Eco estÃ¡ em estÃ¡gio inicial, mas jÃ¡ possui uma estrutura sÃ³lida e bem organizada. Aqui estÃ¡ o que foi implementado:

## STACK TECNOLÃ“GICA ATUAL

- **Runtime:** Node.js com TypeScript
- **Framework:** Express.js v4.19.2
- **Banco de Dados:** PostgreSQL
- **Query Builder:** Knex.js v3.1.0
- **ValidaÃ§Ã£o:** Zod v3.23.8
- **Desenvolvimento:** tsx (TypeScript executor)

## ESTRUTURA DE ARQUIVOS

```
backend/
â”œâ”€â”€ server.ts                    # Servidor principal (porta 3333)
â”œâ”€â”€ knexfile.ts                  # ConfiguraÃ§Ã£o do Knex
â”œâ”€â”€ tsconfig.json               # ConfiguraÃ§Ã£o TypeScript
â”œâ”€â”€ package.json                # DependÃªncias e scripts
â””â”€â”€ src/
    â”œâ”€â”€ controllers/            # Controllers (vazio)
    â”œâ”€â”€ routes/                 # Rotas (vazio)
    â”œâ”€â”€ middlewares/
    â”‚   â””â”€â”€ errorHandling.ts    # Middleware de tratamento de erros
    â”œâ”€â”€ utils/
    â”‚   â””â”€â”€ AppError.ts         # Classe de erro personalizada
    â””â”€â”€ database/
        â”œâ”€â”€ knex.ts             # InstÃ¢ncia do Knex
        â””â”€â”€ migrations/
            â””â”€â”€ 20250621210820_create-register.ts # Migration da tabela de usuÃ¡rios
```

## CONFIGURAÃ‡Ã•ES IMPORTANTES

### 1. TypeScript (tsconfig.json)

- **Target:** ES2022
- **Module:** node16 (ESM)
- **Flags importantes:**
  - `allowImportingTsExtensions: true` (permite importar .ts)
  - `esModuleInterop: true` (compatibilidade com CommonJS)
  - `noEmit: true` (nÃ£o gera arquivos JS)
- **Inclui:** src/\*_/_ e server.ts

### 2. Package.json

- **Type:** "module" (ESM habilitado)
- **Scripts:**
  - `dev`: tsx watch src/server.ts (desenvolvimento)
  - `knex`: node --import tsx ./node_modules/.bin/knex (comandos Knex)

### 3. ConfiguraÃ§Ã£o do Banco (knexfile.ts)

```typescript
{
  development: {
    client: 'pg',
    connection: {
      host: 'localhost',
      port: 5432,
      user: 'postgres',
      password: 'admin123',
      database: 'ecodatabase'
    },
    migrations: {
      directory: './src/database/migrations',
      extension: 'ts'
    },
    seeds: {
      directory: './src/database/seeds',
      extension: 'ts'
    }
  }
}
```

## ESTRUTURA DO BANCO DE DADOS

### Tabela: register (usuÃ¡rios)

```sql
CREATE TABLE register (
  id UUID PRIMARY KEY,           -- UUID gerado pelo backend
  email VARCHAR UNIQUE NOT NULL,
  senha VARCHAR NOT NULL,
  codinome VARCHAR UNIQUE NOT NULL, -- Gerado automaticamente
  genero VARCHAR NOT NULL,       -- M/F/N
  avatar_url VARCHAR NOT NULL,   -- URL do avatar gerado
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

## MIDDLEWARE E TRATAMENTO DE ERROS

### AppError (src/utils/AppError.ts)

Classe personalizada para erros da aplicaÃ§Ã£o:

```typescript
class AppError {
  message: string;
  statusCode: number;
  constructor(message: string, statusCode = 400) {
    this.message = message;
    this.statusCode = statusCode;
  }
}
```

### Error Handling Middleware

Trata trÃªs tipos de erro:

1. **AppError:** Erros personalizados da aplicaÃ§Ã£o
2. **ZodError:** Erros de validaÃ§Ã£o do Zod
3. **Erros gerais:** Retorna status 500

## COMANDOS KNEX IMPORTANTES

```bash
# Executar migrations
npm run knex migrate:latest

# Reverter migrations
npm run knex migrate:rollback

# Criar nova migration
npm run knex migrate:make nome_da_migration

# Criar seed
npm run knex seed:make nome_do_seed
```

## PRÃ“XIMOS PASSOS SUGERIDOS

1. **Implementar Controllers e Routes:**

   - AuthController (registro/login)
   - EcoController (CRUD de ecos)
   - SussurroController (CRUD de sussurros)

2. **Criar Migrations Faltantes:**

   - Tabela `ecos` (id, user_id, titulo, historia, tags, created_at)
   - Tabela `sussurros` (id, eco_id, conteudo, created_at)
   - Tabela `tags` (id, nome)

3. **Implementar AutenticaÃ§Ã£o:**

   - JWT tokens
   - Middleware de autenticaÃ§Ã£o
   - Hash de senhas (bcrypt)

4. **ValidaÃ§Ã£o com Zod:**
   - Schemas de validaÃ§Ã£o para todas as rotas
   - Middleware de validaÃ§Ã£o

## REGRAS DE NEGÃ“CIO IMPORTANTES

- **Anonimato:** Codinomes sÃ£o gerados automaticamente
- **Limite:** MÃ¡ximo 10 sussurros por eco
- **AutenticaÃ§Ã£o:** Apenas usuÃ¡rios autenticados podem criar ecos/sussurros
- **Privacidade:** Nenhum dado pessoal Ã© exposto publicamente

## NOTAS TÃ‰CNICAS

- O servidor roda na porta 3333
- Todas as importaÃ§Ãµes usam extensÃ£o .ts
- O projeto usa ESM (import/export)
- Banco local PostgreSQL configurado
- Middleware de erro jÃ¡ implementado e funcional

## COMANDOS PARA DESENVOLVIMENTO

```bash
# Instalar dependÃªncias
npm install

# Rodar em desenvolvimento
npm run dev

# Executar migrations
npm run knex migrate:latest

# Verificar status das migrations
npm run knex migrate:status
```

Este backend estÃ¡ pronto para receber a implementaÃ§Ã£o das rotas e controllers principais do projeto Eco.

---

ðŸ“‚ Rotas e Controllers â€“ Projeto Eco
Estrutura implementada:

RegisterController:
Controller responsÃ¡vel pelo cadastro (POST /register) e listagem de usuÃ¡rios (GET /register).

ValidaÃ§Ã£o dos dados com Zod.

Hash seguro da senha com bcryptjs.

Tratamento de erros personalizados usando AppError.

Busca e cadastro no banco via Knex com tipagem TypeScript.

registerRoutes:
Arquivo de rotas dedicado ao usuÃ¡rio.

Define as rotas /register usando o Router do Express.

Garante o contexto do this do controller usando arrow functions ou .bind.

index.ts (routes):
Arquivo principal de rotas.

Junta todas as rotas do projeto e exporta como um Ãºnico router.

Usa routes.use('/register', registerRoutes) para montar as rotas de cadastro.

PadrÃµes e boas prÃ¡ticas adotadas:

Tipagem explÃ­cita dos dados do usuÃ¡rio (Register) usando o generic <Register> do Knex para maior seguranÃ§a.

Nunca retorna a senha nos endpoints de listagem.

Imports organizados com alias @ (via tsconfig).
